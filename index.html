<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Marble Ludo</title>
<style>
body{font-family:Arial;text-align:center;background:#f2f2f2}
canvas{background:white;border:2px solid black;margin-top:15px}
button{margin-top:10px;padding:8px 16px;font-size:16px}
#info{margin-top:6px;font-weight:bold}
#marbles{margin-top:10px}
.marble{width:24px;height:24px;border-radius:50%;display:inline-block;margin:4px;border:1px solid #333}
.white{background:#f5f5f5}
.black{background:#222}
</style>
</head>
<body>

<h2>Marble Ludo</h2>
<button id="drawBtn" onclick="playTurn()">Draw Marbles</button>
<div id="marbles"></div>
<div id="info"></div>

<canvas id="board" width="400" height="400"></canvas>

<script>
/* ===== CONFIG ===== */
const GRID=5, CELL=80, MAX_EXTRA_DRAWS=2;
const STEP_DELAY = 180;

/* ===== BOARD ===== */
const board=[
 [0,0,1,0,0],
 [0,0,0,0,0],
 [1,0,2,0,1],
 [0,0,0,0,0],
 [0,0,1,0,0]
];

/* ===== PATHS ===== */
const outerPath=[
 {x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},
 {x:4,y:1},{x:4,y:2},{x:4,y:3},{x:4,y:4},
 {x:3,y:4},{x:2,y:4},{x:1,y:4},{x:0,y:4},
 {x:0,y:3},{x:0,y:2},{x:0,y:1}
];

const innerPath=[
 {x:2,y:3},{x:3,y:2},{x:2,y:1},{x:1,y:2}
];

const FINISH={x:2,y:2};

/* ===== PLAYERS ===== */
const players=[
 {name:"P1",color:"blue",start:{x:2,y:4},tokens:[]},
 {name:"P2",color:"green",start:{x:4,y:2},tokens:[]},
 {name:"P3",color:"purple",start:{x:2,y:0},tokens:[]},
 {name:"P4",color:"orange",start:{x:0,y:2},tokens:[]}
];

players.forEach(p=>{
 const idx=outerPath.findIndex(q=>q.x===p.start.x&&q.y===p.start.y);
 for(let i=0;i<4;i++){
  p.tokens.push({mode:"outer",outerIndex:idx,innerIndex:0,finished:false});
 }
});

let currentPlayer=0, selectedToken=0, extraDrawsUsed=0, gameOver=false;
let animating=false;

const canvas=document.getElementById("board");
const ctx=canvas.getContext("2d");
const info=document.getElementById("info");
const marblesDiv=document.getElementById("marbles");

/* ===== DRAW BOARD ===== */
function drawBoard(){
 ctx.clearRect(0,0,400,400);
// arrows (guides)
ctx.fillStyle = "#aaa";
ctx.fillText("⟲", 190, 30);   // outer loop (anticlockwise)
ctx.fillText("⟳", 190, 215);  // inner loop (clockwise)
 
ctx.font = "24px Arial";
ctx.fillStyle = "#888";
ctx.fillText("⟲ OUTER", 140, 28);
ctx.fillText("⟳ INNER", 140, 235);
// ===== DRAW DIRECTION ARROWS =====
ctx.strokeStyle = "#888";
ctx.fillStyle = "#888";
ctx.lineWidth = 2;

// Outer loop arrows (anticlockwise)
drawArrow(200, 10, 160, 10);   // top
drawArrow(390, 200, 390, 160); // right
drawArrow(200, 390, 240, 390); // bottom
drawArrow(10, 200, 10, 240);   // left

// Inner loop arrows (clockwise)
drawArrow(200, 250, 240, 210);
drawArrow(250, 200, 200, 160);
drawArrow(200, 150, 160, 200);
drawArrow(150, 200, 200, 240);
function drawArrow(x1,y1,x2,y2){
 const head=8;
 const angle=Math.atan2(y2-y1,x2-x1);
 ctx.beginPath();
 ctx.moveTo(x1,y1);
 ctx.lineTo(x2,y2);
 ctx.stroke();
 ctx.beginPath();
 ctx.moveTo(x2,y2);
 ctx.lineTo(x2-head*Math.cos(angle-Math.PI/6), y2-head*Math.sin(angle-Math.PI/6));
 ctx.lineTo(x2-head*Math.cos(angle+Math.PI/6), y2-head*Math.sin(angle+Math.PI/6));
 ctx.lineTo(x2,y2);
 ctx.fill();
}

 for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++){
  ctx.fillStyle=board[y][x]==1?"#f4a261":board[y][x]==2?"#90dbf4":"#fff";
  ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
  ctx.strokeRect(x*CELL,y*CELL,CELL,CELL);
  if(board[y][x]==2)ctx.fillText("FINISH",x*CELL+18,y*CELL+45);
 }

 ctx.fillStyle="#aaa";
 ctx.fillText("⟲",190,30);
 ctx.fillText("⟳",190,215);

 players.forEach((p,pi)=>{
  p.tokens.forEach((t,i)=>{
   if(t.finished)return;
   let pos=t.mode==="outer"?outerPath[t.outerIndex]:
           t.mode==="inner"?innerPath[t.innerIndex]:FINISH;
   ctx.beginPath();
   ctx.fillStyle=(pi===currentPlayer&&i===selectedToken)?"red":p.color;
   ctx.arc(
    pos.x*CELL+CELL/2+(i%2)*6,
    pos.y*CELL+CELL/2+Math.floor(i/2)*6,
    11,0,Math.PI*2
   );
   ctx.fill();
  });
 });
}

/* ===== MARBLES ===== */
function drawMarbles(){
 marblesDiv.innerHTML="";
 let m=[],w;
 for(let i=0;i<4;i++){
  let v=Math.random()<0.5?"W":"B"; m.push(v);
  let d=document.createElement("div");
  d.className="marble "+(v==="W"?"white":"black");
  marblesDiv.appendChild(d);
 }
 w=m.filter(x=>x==="W").length;
 let steps,extra=false;
 if(w===4){steps=4;extra=true}
 else if(w===3)steps=1;
 else if(w===2)steps=2;
 else if(w===1)steps=3;
 else{steps=(players[currentPlayer].tokens[selectedToken].mode==="outer")?8:9;extra=true}
 info.innerText=`${players[currentPlayer].name} → ${steps} steps`;
 return{steps,extra};
}

/* ===== MOVE ===== */
function moveOneStep(t){
 if(t.mode==="outer"){
  t.outerIndex=(t.outerIndex+1)%outerPath.length;
  let p=outerPath[t.outerIndex];
  if(board[p.y][p.x]===1 && p.x===2 && p.y!==2){
   t.mode="inner"; t.innerIndex=0;
  }
 }else if(t.mode==="inner"){
  t.innerIndex++;
  if(t.innerIndex===innerPath.length){t.finished=true; return "finish";}
 }
}

/* ===== ANIMATED MOVE ===== */
function animateMove(steps,callback){
 let t=players[currentPlayer].tokens[selectedToken];
 if(steps<=0||t.finished){callback();return;}
 animating=true;
 moveOneStep(t);
 drawBoard();
 setTimeout(()=>animateMove(steps-1,callback),STEP_DELAY);
}

/* ===== TURN ===== */
function playTurn(){
 if(gameOver||animating)return;
 let r=drawMarbles();
 animateMove(r.steps,()=>{
  drawBoard();
  animating=false;
  if((r.extra)&&extraDrawsUsed<MAX_EXTRA_DRAWS){
   extraDrawsUsed++;
  }else{
   extraDrawsUsed=0;
   currentPlayer=(currentPlayer+1)%4;
  }
 });
}

/* ===== TOKEN SELECT ===== */
canvas.addEventListener("click",e=>{
 if(gameOver||animating)return;
 let r=canvas.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
 players[currentPlayer].tokens.forEach((t,i)=>{
  if(t.finished)return;
  let p=t.mode==="outer"?outerPath[t.outerIndex]:
        t.mode==="inner"?innerPath[t.innerIndex]:FINISH;
  if(Math.hypot(x-(p.x*CELL+CELL/2),y-(p.y*CELL+CELL/2))<16){
   selectedToken=i; drawBoard();
  }
 });
});

drawBoard();
</script>
</body>
</html>
