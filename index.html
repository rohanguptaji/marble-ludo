<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Marble Ludo â€“ Final</title>
<style>
body{font-family:Arial;text-align:center;background:#f2f2f2}
canvas{background:white;border:2px solid black;margin-top:15px}
button{margin-top:10px;padding:8px 16px;font-size:16px}
#info{margin-top:8px;font-weight:bold}
</style>
</head>
<body>

<h2>Marble Ludo</h2>
<button id="drawBtn" onclick="playTurn()">Draw Marbles</button>
<div id="info"></div>

<canvas id="board" width="400" height="400"></canvas>

<script>
/* ===== CONFIG ===== */
const GRID=5, CELL=80, MAX_EXTRA_DRAWS=2;

/* ===== BOARD ===== */
const board=[
 [0,0,1,0,0],
 [0,0,0,0,0],
 [1,0,2,0,1],
 [0,0,0,0,0],
 [0,0,1,0,0]
];

/* ===== PATHS ===== */
const outerPath=[
 {x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},
 {x:4,y:1},{x:4,y:2},{x:4,y:3},{x:4,y:4},
 {x:3,y:4},{x:2,y:4},{x:1,y:4},{x:0,y:4},
 {x:0,y:3},{x:0,y:2},{x:0,y:1}
];

const innerPath=[
 {x:2,y:3},{x:3,y:2},{x:2,y:1},{x:1,y:2}
];

const FINISH={x:2,y:2};

/* ===== PLAYERS ===== */
const players=[
 {name:"P1",color:"blue",start:{x:2,y:4},tokens:[]},
 {name:"P2",color:"green",start:{x:4,y:2},tokens:[]},
 {name:"P3",color:"purple",start:{x:2,y:0},tokens:[]},
 {name:"P4",color:"orange",start:{x:0,y:2},tokens:[]}
];

players.forEach(p=>{
 const idx=outerPath.findIndex(q=>q.x===p.start.x&&q.y===p.start.y);
 for(let i=0;i<4;i++){
  p.tokens.push({mode:"outer",outerIndex:idx,innerIndex:0,finished:false});
 }
});

let currentPlayer=0, selectedToken=0, extraDrawsUsed=0, gameOver=false;

const canvas=document.getElementById("board");
const ctx=canvas.getContext("2d");
const info=document.getElementById("info");
const drawBtn=document.getElementById("drawBtn");

/* ===== DRAW ===== */
function drawBoard(){
 ctx.clearRect(0,0,400,400);
 for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++){
  ctx.fillStyle=board[y][x]==1?"#f4a261":board[y][x]==2?"#90dbf4":"#fff";
  ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
  ctx.strokeRect(x*CELL,y*CELL,CELL,CELL);
  if(board[y][x]==2)ctx.fillText("FINISH",x*CELL+18,y*CELL+45);
 }
 players.forEach((p,pi)=>{
  p.tokens.forEach((t,i)=>{
   if(t.finished)return;
   let pos=t.mode==="outer"?outerPath[t.outerIndex]:
           t.mode==="inner"?innerPath[t.innerIndex]:FINISH;
   ctx.beginPath();
   ctx.fillStyle=(pi===currentPlayer&&i===selectedToken)?"red":p.color;
   ctx.arc(pos.x*CELL+CELL/2,pos.y*CELL+CELL/2,12,0,Math.PI*2);
   ctx.fill();
  });
 });
}

/* ===== MARBLES ===== */
function drawMarbles(){
 let m=[], w;
 for(let i=0;i<4;i++)m.push(Math.random()<0.5?"W":"B");
 w=m.filter(x=>x==="W").length;
 let steps,extra=false;
 if(w===4){steps=4;extra=true}
 else if(w===3)steps=1;
 else if(w===2)steps=2;
 else if(w===1)steps=3;
 else{steps=(players[currentPlayer].tokens[selectedToken].mode==="outer")?8:9;extra=true}
 info.innerText=`${players[currentPlayer].name}: ${m.join(" ")} â†’ ${steps}`;
 return{steps,extra};
}

/* ===== MOVE ===== */
function moveOneStep(t){
 if(t.mode==="outer"){
  t.outerIndex=(t.outerIndex+1)%outerPath.length;
  let p=outerPath[t.outerIndex];
  if(board[p.y][p.x]===1 && p.x===2 && p.y!==2){
   t.mode="inner"; t.innerIndex=0;
  }
 }else if(t.mode==="inner"){
  t.innerIndex++;
  if(t.innerIndex===innerPath.length){t.finished=true; return "finish";}
 }
}

/* ===== CAPTURE ===== */
function checkCapture(){
 let atk=players[currentPlayer];
 let pos=outerPath[atk.tokens[selectedToken].outerIndex];
 if(board[pos.y][pos.x]===1)return false;
 for(let pi=0;pi<players.length;pi++){
  if(pi===currentPlayer)continue;
  for(let t of players[pi].tokens){
   if(!t.finished && t.mode==="outer"){
    let p=outerPath[t.outerIndex];
    if(p.x===pos.x&&p.y===pos.y){
     t.outerIndex=outerPath.findIndex(q=>q.x===players[pi].start.x&&q.y===players[pi].start.y);
     t.mode="outer"; t.innerIndex=0;
     return true;
    }
   }
  }
 }
 return false;
}

/* ===== WIN ===== */
function checkWin(){
 if(players[currentPlayer].tokens.every(t=>t.finished)){
  info.innerText=`ðŸŽ‰ ${players[currentPlayer].name} WINS!`;
  drawBtn.disabled=true;
  gameOver=true;
 }
}

/* ===== TURN ===== */
function playTurn(){
 if(gameOver)return;
 let r=drawMarbles(), t=players[currentPlayer].tokens[selectedToken], finished=false;
 for(let i=0;i<r.steps;i++){
  if(t.finished)break;
  if(moveOneStep(t)==="finish"){finished=true;break;}
 }
 let captured=checkCapture();
 drawBoard(); checkWin();
 if(gameOver)return;
 if((r.extra||captured||finished)&&extraDrawsUsed<MAX_EXTRA_DRAWS){
  extraDrawsUsed++;
 }else{
  extraDrawsUsed=0;
  currentPlayer=(currentPlayer+1)%4;
 }
}

/* ===== TOKEN SELECT ===== */
canvas.addEventListener("click",e=>{
 if(gameOver)return;
 let r=canvas.getBoundingClientRect(),x=e.clientX-r.left,y=e.clientY-r.top;
 players[currentPlayer].tokens.forEach((t,i)=>{
  if(t.finished)return;
  let p=t.mode==="outer"?outerPath[t.outerIndex]:
        t.mode==="inner"?innerPath[t.innerIndex]:FINISH;
  if(Math.hypot(x-(p.x*CELL+CELL/2),y-(p.y*CELL+CELL/2))<14){
   selectedToken=i; drawBoard();
  }
 });
});

drawBoard();
</script>

</body>
</html>
