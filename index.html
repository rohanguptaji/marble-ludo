<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Marble Ludo</title>
<style>
body{font-family:Arial;background:#f2f2f2;display:flex;justify-content:center}
#game{position:relative;width:520px}
canvas{background:#fff;border:2px solid black;margin:60px auto;display:block}
button{position:absolute;top:0;left:50%;transform:translateX(-50%);padding:8px 16px}
.playerBox{position:absolute;width:120px;padding:6px;border:2px solid #999;background:#fff;text-align:center}
.playerBox.active{border-color:black;font-weight:bold}
.marble{width:18px;height:18px;border-radius:50%;border:1px solid #333}
.marbles{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;justify-items:center;margin-top:6px}
.white{background:#f5f5f5}
.black{background:#222}
</style>
</head>

<body>
<div id="game">
<button onclick="playTurn()">Draw Marbles</button>

<div id="p0" class="playerBox" style="bottom:0;left:200px;color:blue">P1<div class="marbles"></div></div>
<div id="p1" class="playerBox" style="right:0;top:200px;color:green">P2<div class="marbles"></div></div>
<div id="p2" class="playerBox" style="top:0;left:200px;color:purple">P3<div class="marbles"></div></div>
<div id="p3" class="playerBox" style="left:0;top:200px;color:orange">P4<div class="marbles"></div></div>

<canvas id="board" width="400" height="400"></canvas>
</div>

<script>
/* ===== CONFIG ===== */
const GRID=5,CELL=80,SLIDE_TIME=220;
const board=[
 [0,0,1,0,0],
 [0,0,0,0,0],
 [1,0,2,0,1],
 [0,0,0,0,0],
 [0,0,1,0,0]
];

/* ===== PATHS ===== */
let outerPath=[
 {x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},
 {x:4,y:1},{x:4,y:2},{x:4,y:3},{x:4,y:4},
 {x:3,y:4},{x:2,y:4},{x:1,y:4},{x:0,y:4},
 {x:0,y:3},{x:0,y:2},{x:0,y:1}
].reverse(); // ANTICLOCKWISE

const innerPath=[{x:2,y:3},{x:3,y:2},{x:2,y:1},{x:1,y:2}];
const FINISH={x:2,y:2};

/* ===== PLAYERS ===== */
const players=[
 {color:"blue",start:{x:2,y:4},tokens:[]},
 {color:"green",start:{x:4,y:2},tokens:[]},
 {color:"purple",start:{x:2,y:0},tokens:[]},
 {color:"orange",start:{x:0,y:2},tokens:[]}
];

players.forEach(p=>{
 const idx=outerPath.findIndex(q=>q.x===p.start.x&&q.y===p.start.y);
 for(let i=0;i<4;i++){
  p.tokens.push({
   mode:"outer",
   outerIndex:idx,
   innerIndex:0,
   finished:false,
   capturedOnce:false,
   px:p.start.x*CELL+CELL/2,
   py:p.start.y*CELL+CELL/2
  });
 }
});

let currentPlayer=0,selectedToken=0,animating=false;
const ctx=document.getElementById("board").getContext("2d");

/* ===== DRAW ===== */
function drawBoard(){
 ctx.clearRect(0,0,400,400);
 for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++){
  ctx.fillStyle=board[y][x]==1?"#f4a261":board[y][x]==2?"#90dbf4":"#fff";
  ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
  ctx.strokeRect(x*CELL,y*CELL,CELL,CELL);
 }

 players.forEach(p=>{
  p.tokens.forEach(t=>{
   if(t.finished)return;
   ctx.beginPath();
   ctx.fillStyle=p.color;
   ctx.arc(t.px,t.py,10,0,Math.PI*2);
   ctx.fill();
  });
 });

 document.querySelectorAll(".playerBox")
  .forEach((b,i)=>b.classList.toggle("active",i===currentPlayer));
}

/* ===== MARBLES ===== */
function drawMarbles(){
 document.querySelectorAll(".marbles").forEach(m=>m.innerHTML="");
 let box=document.querySelector(`#p${currentPlayer} .marbles`);
 let whites=0;
 for(let i=0;i<4;i++){
  let w=Math.random()<0.5;
  if(w)whites++;
  let d=document.createElement("div");
  d.className="marble "+(w?"white":"black");
  box.appendChild(d);
 }
 let t=players[currentPlayer].tokens[selectedToken];
 if(whites===1)return 1;
 if(whites===2)return 2;
 if(whites===3)return 2;
 if(whites===4)return t.mode==="outer"?8:9;
 return 4;
}

/* ===== MOVE LOGIC ===== */
function moveOneLogicalStep(t){
 if(t.mode==="outer"){
  t.outerIndex=(t.outerIndex+1)%outerPath.length;
  let p=outerPath[t.outerIndex];

  // INNER ENTRY ONLY IF CAPTURED
  if(board[p.y][p.x]===1 && p.x===2 && p.y!==2 && t.capturedOnce){
   t.mode="inner";
   t.innerIndex=0;
  }
 }else if(t.mode==="inner"){
  t.innerIndex++;
  if(t.innerIndex===innerPath.length)t.finished=true;
 }
}

/* ===== SMOOTH SLIDE ===== */
function slideTo(t,targetX,targetY,cb){
 let sx=t.px, sy=t.py, start=null;
 function anim(ts){
  if(!start)start=ts;
  let p=Math.min((ts-start)/SLIDE_TIME,1);
  t.px=sx+(targetX-sx)*p;
  t.py=sy+(targetY-sy)*p;
  drawBoard();
  if(p<1)requestAnimationFrame(anim);
  else cb();
 }
 requestAnimationFrame(anim);
}

function animateSteps(steps){
 if(steps<=0){animating=false;currentPlayer=(currentPlayer+1)%4;return;}
 let t=players[currentPlayer].tokens[selectedToken];
 if(t.finished){animating=false;return;}

 let next =
  t.mode==="outer"?outerPath[(t.outerIndex+1)%outerPath.length]:
  innerPath[t.innerIndex+1];

 slideTo(
  t,
  next.x*CELL+CELL/2,
  next.y*CELL+CELL/2,
  ()=>{
   moveOneLogicalStep(t);
   animateSteps(steps-1);
  }
 );
}

/* ===== TURN ===== */
function playTurn(){
 if(animating)return;
 animating=true;
 let steps=drawMarbles();
 animateSteps(steps);
}

drawBoard();
</script>
</body>
</html>
