<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Marble Ludo – Stable</title>

<style>
body{
  font-family:Arial, sans-serif;
  background:#f2f2f2;
  display:flex;
  justify-content:center;
}
#game{
  position:relative;
  width:520px;
}
canvas{
  background:#fff;
  border:2px solid #000;
  margin:60px auto;
  display:block;
}
button{
  position:absolute;
  top:0;
  left:50%;
  transform:translateX(-50%);
  padding:8px 16px;
  font-size:16px;
}
.playerBox{
  position:absolute;
  width:120px;
  padding:6px;
  border:2px solid #999;
  background:#fff;
  text-align:center;
  font-size:14px;
}
.playerBox.active{
  border-color:#000;
  font-weight:bold;
}
.marbles{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:6px;
  justify-items:center;
  margin-top:6px;
}
.marble{
  width:18px;
  height:18px;
  border-radius:50%;
  border:1px solid #333;
}
.white{background:#f5f5f5;}
.black{background:#222;}
</style>
</head>

<body>
<div id="game">

<button onclick="playTurn()">Draw Marbles</button>

<div id="p0" class="playerBox" style="bottom:0;left:200px;color:blue">
P1<br>Blue<div class="marbles"></div>
</div>

<div id="p1" class="playerBox" style="right:0;top:200px;color:green">
P2<br>Green<div class="marbles"></div>
</div>

<div id="p2" class="playerBox" style="top:0;left:200px;color:purple">
P3<br>Purple<div class="marbles"></div>
</div>

<div id="p3" class="playerBox" style="left:0;top:200px;color:orange">
P4<br>Orange<div class="marbles"></div>
</div>

<canvas id="board" width="400" height="400"></canvas>
</div>

<script>
/* ===== CONFIG ===== */
const GRID=5, CELL=80;

/* ===== BOARD ===== */
const board=[
 [0,0,1,0,0],
 [0,0,0,0,0],
 [1,0,2,0,1],
 [0,0,0,0,0],
 [0,0,1,0,0]
];

/* ===== PATHS ===== */
// defined clockwise then reversed → anticlockwise
let outerPath=[
 {x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},
 {x:4,y:1},{x:4,y:2},{x:4,y:3},{x:4,y:4},
 {x:3,y:4},{x:2,y:4},{x:1,y:4},{x:0,y:4},
 {x:0,y:3},{x:0,y:2},{x:0,y:1}
].reverse();

const innerPath=[
 {x:2,y:3},
 {x:3,y:2},
 {x:2,y:1},
 {x:1,y:2}
];

const FINISH={x:2,y:2};

/* ===== PLAYERS ===== */
const players=[
 {name:"P1",color:"blue",start:{x:2,y:4},tokens:[]},
 {name:"P2",color:"green",start:{x:4,y:2},tokens:[]},
 {name:"P3",color:"purple",start:{x:2,y:0},tokens:[]},
 {name:"P4",color:"orange",start:{x:0,y:2},tokens:[]}
];

players.forEach(p=>{
 const idx=outerPath.findIndex(q=>q.x===p.start.x&&q.y===p.start.y);
 for(let i=0;i<4;i++){
  p.tokens.push({
   mode:"outer",
   outerIndex:idx,
   innerIndex:0,
   finished:false
  });
 }
});

let currentPlayer=0;
let selectedToken=0;

const canvas=document.getElementById("board");
const ctx=canvas.getContext("2d");

const STACK=[
 {x:-12,y:-12},
 {x: 12,y:-12},
 {x:-12,y: 12},
 {x: 12,y: 12}
];

/* ===== ARROWS ===== */
function drawArrow(x1,y1,x2,y2){
 const h=7,a=Math.atan2(y2-y1,x2-x1);
 ctx.strokeStyle="#4a90e2";
 ctx.fillStyle="#4a90e2";
 ctx.lineWidth=3;
 ctx.beginPath();
 ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();
 ctx.beginPath();
 ctx.moveTo(x2,y2);
 ctx.lineTo(x2-h*Math.cos(a-Math.PI/6),y2-h*Math.sin(a-Math.PI/6));
 ctx.lineTo(x2-h*Math.cos(a+Math.PI/6),y2-h*Math.sin(a+Math.PI/6));
 ctx.closePath();ctx.fill();
}

function drawPathArrows(path){
 for(let i=0;i<path.length;i++){
  const a=path[i],b=path[(i+1)%path.length];
  if(board[a.y][a.x]!==0||board[b.y][b.x]!==0)continue;
  drawArrow(
   a.x*CELL+CELL/2,a.y*CELL+CELL/2,
   b.x*CELL+CELL/2,b.y*CELL+CELL/2
  );
 }
}

/* ===== DRAW ===== */
function drawBoard(){
 ctx.clearRect(0,0,400,400);

 for(let y=0;y<GRID;y++)for(let x=0;x<GRID;x++){
  ctx.fillStyle=
   board[y][x]===1?"#f4a261":
   board[y][x]===2?"#90dbf4":"#fff";
  ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
  ctx.strokeRect(x*CELL,y*CELL,CELL,CELL);
 }

 drawPathArrows(outerPath);
 drawPathArrows(innerPath);

 players.forEach(p=>{
  const groups={};
  p.tokens.forEach(t=>{
   if(t.finished)return;
   let pos=t.mode==="outer"?outerPath[t.outerIndex]:innerPath[t.innerIndex];
   const k=`${pos.x},${pos.y}`;
   if(!groups[k])groups[k]=[];
   groups[k].push(pos);
  });

  Object.values(groups).forEach((grp,i)=>{
   grp.forEach((pos,j)=>{
    ctx.beginPath();
    ctx.fillStyle=p.color;
    ctx.arc(
     pos.x*CELL+CELL/2+STACK[j].x,
     pos.y*CELL+CELL/2+STACK[j].y,
     10,0,Math.PI*2
    );
    ctx.fill();
   });
  });
 });

 document.querySelectorAll(".playerBox")
  .forEach((b,i)=>b.classList.toggle("active",i===currentPlayer));
}

/* ===== MARBLES ===== */
function drawMarbles(){
 document.querySelectorAll(".marbles").forEach(m=>m.innerHTML="");
 let box=document.querySelector(`#p${currentPlayer} .marbles`);
 let whites=0;
 for(let i=0;i<4;i++){
  let w=Math.random()<0.5;
  if(w)whites++;
  let d=document.createElement("div");
  d.className="marble "+(w?"white":"black");
  box.appendChild(d);
 }
 if(whites===1)return 1;
 if(whites===2)return 2;
 if(whites===3)return 2;
 if(whites===4)return players[currentPlayer].tokens[selectedToken].mode==="outer"?8:9;
 return 4;
}

/* ===== MOVE ===== */
function moveSteps(steps){
 let t=players[currentPlayer].tokens[selectedToken];
 while(steps-- && !t.finished){
  if(t.mode==="outer"){
   t.outerIndex=(t.outerIndex+1)%outerPath.length;
   let p=outerPath[t.outerIndex];
   if(board[p.y][p.x]===1 && p.x===2 && p.y!==2){
    t.mode="inner";t.innerIndex=0;
   }
  }else{
   t.innerIndex++;
   if(t.innerIndex===innerPath.length)t.finished=true;
  }
 }
}

/* ===== TURN ===== */
function playTurn(){
 let steps=drawMarbles();
 moveSteps(steps);
 currentPlayer=(currentPlayer+1)%4;
 drawBoard();
}

drawBoard();
</script>
</body>
</html>
