<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Marble Ludo</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f2f2f2;
  display:flex;
  justify-content:center;
}
#game{
  position:relative;
  width:520px;
}
canvas{
  background:white;
  border:2px solid black;
  margin:60px auto;
  display:block;
}
button{
  position:absolute;
  top:0;
  left:50%;
  transform:translateX(-50%);
  padding:8px 16px;
  font-size:16px;
}
.playerBox{
  position:absolute;
  width:120px;
  padding:6px;
  border:2px solid #999;
  background:#fff;
  text-align:center;
  font-size:14px;
}
.playerBox.active{
  border-color:black;
  font-weight:bold;
}
.marble{
  width:18px;
  height:18px;
  border-radius:50%;
  display:inline-block;
  margin:2px;
  border:1px solid #333;
}
.white{ background:#f5f5f5; }
.black{ background:#222; }

#info{
  text-align:center;
  font-weight:bold;
  margin-top:6px;
}
</style>
</head>

<body>
<div id="game">

<button onclick="playTurn()">Draw Marbles</button>
<div id="info"></div>

<!-- Player boxes -->
<div id="p0" class="playerBox" style="bottom:0;left:200px;color:blue">
P1<br>Blue<div class="marbles"></div>
</div>

<div id="p1" class="playerBox" style="right:0;top:200px;color:green">
P2<br>Green<div class="marbles"></div>
</div>

<div id="p2" class="playerBox" style="top:0;left:200px;color:purple">
P3<br>Purple<div class="marbles"></div>
</div>

<div id="p3" class="playerBox" style="left:0;top:200px;color:orange">
P4<br>Orange<div class="marbles"></div>
</div>

<canvas id="board" width="400" height="400"></canvas>
</div>

<script>
/* ================= CONFIG ================= */
const GRID = 5;
const CELL = 80;
const STEP_DELAY = 260;

/* ================= BOARD ================= */
const board = [
 [0,0,1,0,0],
 [0,0,0,0,0],
 [1,0,2,0,1],
 [0,0,0,0,0],
 [0,0,1,0,0]
];

/* ================= PATHS ================= */
let outerPath = [
 {x:0,y:0},{x:1,y:0},{x:2,y:0},{x:3,y:0},{x:4,y:0},
 {x:4,y:1},{x:4,y:2},{x:4,y:3},{x:4,y:4},
 {x:3,y:4},{x:2,y:4},{x:1,y:4},{x:0,y:4},
 {x:0,y:3},{x:0,y:2},{x:0,y:1}
];

// OUTER LOOP MUST BE ANTICLOCKWISE
outerPath.reverse();

const innerPath = [
 {x:2,y:3},
 {x:3,y:2},
 {x:2,y:1},
 {x:1,y:2}
];

const FINISH = {x:2,y:2};

/* ================= PLAYERS ================= */
const players = [
 {name:"P1", color:"blue",   start:{x:2,y:4}, tokens:[]},
 {name:"P2", color:"green",  start:{x:4,y:2}, tokens:[]},
 {name:"P3", color:"purple", start:{x:2,y:0}, tokens:[]},
 {name:"P4", color:"orange", start:{x:0,y:2}, tokens:[]}
];

players.forEach(p=>{
 const idx = outerPath.findIndex(q=>q.x===p.start.x && q.y===p.start.y);
 for(let i=0;i<4;i++){
  p.tokens.push({
   mode:"outer",
   outerIndex:idx,
   innerIndex:0,
   finished:false
  });
 }
});

let currentPlayer = 0;
let selectedToken = 0;
let animating = false;

const canvas = document.getElementById("board");
const ctx = canvas.getContext("2d");
const info = document.getElementById("info");

const STACK_POSITIONS = [
 {x:-12,y:-12},
 {x: 12,y:-12},
 {x:-12,y: 12},
 {x: 12,y: 12}
];

/* ================= DRAW HELPERS ================= */
function drawArrow(x1,y1,x2,y2){
 const head=8;
 const angle=Math.atan2(y2-y1,x2-x1);
 ctx.strokeStyle="#4a90e2";
 ctx.fillStyle="#4a90e2";
 ctx.lineWidth=3;

 ctx.beginPath();
 ctx.moveTo(x1,y1);
 ctx.lineTo(x2,y2);
 ctx.stroke();

 ctx.beginPath();
 ctx.moveTo(x2,y2);
 ctx.lineTo(x2-head*Math.cos(angle-Math.PI/6),y2-head*Math.sin(angle-Math.PI/6));
 ctx.lineTo(x2-head*Math.cos(angle+Math.PI/6),y2-head*Math.sin(angle+Math.PI/6));
 ctx.closePath();
 ctx.fill();
}

function drawPathArrows(path){
 for(let i=0;i<path.length;i++){
  const a = path[i];
  const b = path[(i+1)%path.length];
  if(board[a.y][a.x]!==0 || board[b.y][b.x]!==0) continue;

  drawArrow(
   a.x*CELL+CELL/2,
   a.y*CELL+CELL/2,
   b.x*CELL+CELL/2,
   b.y*CELL+CELL/2
  );
 }
}

/* ================= DRAW BOARD ================= */
function drawBoard(){
 ctx.clearRect(0,0,400,400);

 for(let y=0;y<GRID;y++){
  for(let x=0;x<GRID;x++){
   ctx.fillStyle = board[y][x]===1 ? "#f4a261" :
                   board[y][x]===2 ? "#90dbf4" : "#fff";
   ctx.fillRect(x*CELL,y*CELL,CELL,CELL);
   ctx.strokeRect(x*CELL,y*CELL,CELL,CELL);
  }
 }

 drawPathArrows(outerPath);
 drawPathArrows(innerPath);

 players.forEach((p,pi)=>{
  let groups={};

  p.tokens.forEach((t,ti)=>{
   if(t.finished) return;
   let pos = t.mode==="outer" ? outerPath[t.outerIndex] :
             t.mode==="inner" ? innerPath[t.innerIndex] : FINISH;
   let key = `${pos.x},${pos.y}`;
   if(!groups[key]) groups[key]=[];
   groups[key].push({token:t,index:ti,pos});
  });

  Object.values(groups).forEach(group=>{
   group.forEach((g,i)=>{
    const cx = g.pos.x*CELL + CELL/2;
    const cy = g.pos.y*CELL + CELL/2;
    const off = STACK_POSITIONS[i] || {x:0,y:0};

    ctx.beginPath();
    ctx.fillStyle = p.color;
    ctx.arc(cx+off.x, cy+off.y, 10, 0, Math.PI*2);
    ctx.fill();
   });
  });
 });

 document.querySelectorAll(".playerBox")
  .forEach((b,i)=>b.classList.toggle("active",i===currentPlayer));
}

/* ================= MARBLES ================= */
function drawMarbles(){
 document.querySelectorAll(".marbles").forEach(m=>m.innerHTML="");

 let box = document.querySelector(`#p${currentPlayer} .marbles`);
 let whites = 0;

 for(let i=0;i<4;i++){
  let isWhite = Math.random()<0.5;
  if(isWhite) whites++;

  let d=document.createElement("div");
  d.className="marble "+(isWhite?"white":"black");
  box.appendChild(d);
 }

 let token = players[currentPlayer].tokens[selectedToken];
 let steps = 0;

 if(whites===1) steps=1;
 else if(whites===2) steps=2;
 else if(whites===3) steps=2;
 else if(whites===4) steps = token.mode==="outer"?8:9;
 else steps=4;

 info.innerText = `${players[currentPlayer].name} â†’ ${steps} moves`;
 return steps;
}

/* ================= MOVE ================= */
function moveOneStep(t){
 if(t.mode==="outer"){
  t.outerIndex=(t.outerIndex+1)%outerPath.length;
  let p=outerPath[t.outerIndex];
  if(board[p.y][p.x]===1 && p.x===2 && p.y!==2){
   t.mode="inner";
   t.innerIndex=0;
  }
 }else if(t.mode==="inner"){
  t.innerIndex++;
  if(t.innerIndex===innerPath.length){
   t.finished=true;
  }
 }
}

function animateMove(steps,cb){
 let t=players[currentPlayer].tokens[selectedToken];
 if(steps<=0||t.finished){cb();return;}
 animating=true;
 moveOneStep(t);
 drawBoard();
 setTimeout(()=>animateMove(steps-1,cb),STEP_DELAY);
}

/* ================= TURN ================= */
function playTurn(){
 if(animating) return;
 let steps = drawMarbles();
 animateMove(steps,()=>{
  animating=false;
  currentPlayer=(currentPlayer+1)%4;
 });
}

drawBoard();
</script>
</body>
</html>
